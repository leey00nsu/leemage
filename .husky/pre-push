#!/bin/sh

echo "ğŸ“„ Verifying OpenAPI spec is up to date..."
npm run openapi:generate

if [ $? -ne 0 ]; then
  echo "âŒ OpenAPI generation failed! Push aborted."
  exit 1
fi

echo "ğŸ“¦ Verifying SDK generated types are up to date..."
npm --prefix packages/sdk run generate

if [ $? -ne 0 ]; then
  echo "âŒ SDK type generation failed! Push aborted."
  exit 1
fi

if ! git diff --quiet -- public/openapi.yaml packages/sdk/src/types/generated.ts; then
  echo "âŒ Generated spec/types are outdated."
  echo "   Run: npm run openapi:generate"
  echo "   Run: npm --prefix packages/sdk run generate"
  echo "   Then commit: git add public/openapi.yaml packages/sdk/src/types/generated.ts && git commit"
  exit 1
fi

echo "ğŸ”¨ Running build check before push..."
npm run build

if [ $? -ne 0 ]; then
  echo "âŒ Build failed! Push aborted."
  exit 1
fi

echo "âœ… Build successful! Proceeding with push."
