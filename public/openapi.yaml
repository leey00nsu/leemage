openapi: 3.0.0
info:
  title: Leemage API
  version: 1.0.0
  description: Leemage file management platform API. Manage files by project and process image transformations.
servers:
  - url: /api/v1
    description: API v1 (API Key authentication)
tags:
  - name: Projects
    description: Project management API
  - name: Files
    description: File upload and management API
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: "API key authentication. Send as 'Authorization: Bearer <API_KEY>'."
  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: An error occurred while processing the request.
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Field-level validation errors
          example:
            name:
              - This field is required.
      required:
        - message
    UnauthorizedError:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: "Authentication failed: invalid API key"
      required:
        - message
    ProjectNotFoundError:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: Resource not found.
      required:
        - message
    FileNotFoundError:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: Resource not found.
      required:
        - message
    ServerError:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: A server error occurred.
      required:
        - message
    BadRequestError:
      type: object
      properties:
        message:
          type: string
          description: Error message
          example: Invalid request format.
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Field-level validation errors
          example:
            name:
              - This field is required.
      required:
        - message
    MessageResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
          example: Operation completed successfully.
      required:
        - message
    VariantOption:
      type: object
      properties:
        sizeLabel:
          anyOf:
            - type: string
              enum:
                - source
                - max300
                - max800
                - max1920
            - type: string
              pattern: ^\d+x\d+$
          description: "Image size label. Presets: source (original), max300 (longest side 300px), max800 (longest side 800px), max1920 (longest side 1920px), or custom resolution (WIDTHxHEIGHT format)."
          example: source
        format:
          type: string
          enum:
            - png
            - jpeg
            - avif
            - webp
          description: Image format
          example: webp
      required:
        - sizeLabel
        - format
    ImageVariantData:
      type: object
      properties:
        url:
          type: string
          format: uri
          description: Image URL
          example: https://objectstorage.ap-seoul-1.oraclecloud.com/...
        width:
          type: integer
          minimum: 1
          description: Image width (px)
          example: 1920
        height:
          type: integer
          minimum: 1
          description: Image height (px)
          example: 1080
        size:
          type: integer
          minimum: 0
          description: File size (bytes)
          example: 102400
        format:
          type: string
          description: Image format
          example: webp
        label:
          type: string
          description: Size label
          example: original
      required:
        - url
        - width
        - height
        - size
        - format
        - label
    PresignRequest:
      type: object
      properties:
        fileName:
          type: string
          minLength: 1
          description: Name of the file to upload
          example: image.jpg
        contentType:
          type: string
          minLength: 1
          description: MIME type of the file
          example: image/jpeg
        fileSize:
          type: integer
          minimum: 1
          description: File size (bytes)
          example: 102400
        width:
          type: integer
          minimum: 1
          description: (Image only) Original image width in pixels. Provide with height to use deterministic source object naming.
          example: 421
        height:
          type: integer
          minimum: 1
          description: (Image only) Original image height in pixels. Provide with width to use deterministic source object naming.
          example: 524
      required:
        - fileName
        - contentType
        - fileSize
      example:
        fileName: image.jpg
        contentType: image/jpeg
        fileSize: 102400
        width: 421
        height: 524
    PresignResponse:
      type: object
      properties:
        presignedUrl:
          type: string
          format: uri
          description: Presigned URL for direct upload to OCI
          example: https://objectstorage.ap-seoul-1.oraclecloud.com/p/...
        objectName:
          type: string
          description: OCI object path
          example: clq1234abcd/file5678efgh.jpg
        objectUrl:
          type: string
          format: uri
          description: Object URL after upload completion
          example: https://objectstorage.ap-seoul-1.oraclecloud.com/n/.../o/...
        fileId:
          type: string
          description: Generated file ID
          example: file5678efgh
        expiresAt:
          type: string
          format: date-time
          description: Presigned URL expiration time (ISO 8601)
          example: 2023-01-01T00:15:00.000Z
      required:
        - presignedUrl
        - objectName
        - objectUrl
        - fileId
        - expiresAt
    ConfirmRequest:
      type: object
      properties:
        fileId:
          type: string
          minLength: 1
          description: File ID from presign response
          example: file5678efgh
        objectName:
          type: string
          minLength: 1
          description: Object name from presign response
          example: clq1234abcd/file5678efgh.jpg
        fileName:
          type: string
          minLength: 1
          description: Original file name
          example: image.jpg
        contentType:
          type: string
          minLength: 1
          description: MIME type of the file
          example: image/jpeg
        fileSize:
          type: integer
          minimum: 1
          description: File size (bytes)
          example: 102400
        variants:
          type: array
          items:
            $ref: "#/components/schemas/VariantOption"
          description: (Image only) Array of image variant options to generate
      required:
        - fileId
        - objectName
        - fileName
        - contentType
        - fileSize
      example:
        fileId: file5678efgh
        objectName: clq1234abcd/file5678efgh.jpg
        fileName: image.jpg
        contentType: image/jpeg
        fileSize: 102400
        variants:
          - sizeLabel: source
            format: webp
          - sizeLabel: max800
            format: jpeg
    FileResponse:
      type: object
      properties:
        id:
          type: string
          description: File ID
          example: file5678efgh
        name:
          type: string
          description: File name
          example: image.jpg
        mimeType:
          type: string
          description: MIME type
          example: image/jpeg
        isImage:
          type: boolean
          description: Whether it is an image file
          example: true
        size:
          type: integer
          minimum: 0
          description: File size (bytes)
          example: 102400
        url:
          type: string
          nullable: true
          format: uri
          description: URL for non-image files
          example: null
        variants:
          type: array
          items:
            $ref: "#/components/schemas/ImageVariantData"
          description: Image variants list (image files only)
        createdAt:
          type: string
          format: date-time
          description: Created at (ISO 8601)
          example: 2023-01-01T00:00:00.000Z
        updatedAt:
          type: string
          format: date-time
          description: Updated at (ISO 8601)
          example: 2023-01-01T00:00:00.000Z
        projectId:
          type: string
          description: Project ID
          example: clq1234abcd
      required:
        - id
        - name
        - mimeType
        - isImage
        - size
        - url
        - variants
        - createdAt
        - updatedAt
        - projectId
    ConfirmResponse:
      type: object
      properties:
        message:
          type: string
          description: Success message
          example: File upload complete
        file:
          $ref: "#/components/schemas/FileResponse"
        variants:
          type: array
          items:
            $ref: "#/components/schemas/ImageVariantData"
          description: Generated image variants
      required:
        - message
        - file
    CreateProjectRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
          description: Project name (3-50 characters)
          example: Website Assets
        description:
          type: string
          maxLength: 200
          description: Project description (max 200 characters)
          example: File collection used for the website
        storageProvider:
          type: string
          enum: &a1
            - OCI
            - R2
          default: OCI
          description: "Storage provider (default: OCI). Allowed values: OCI, R2"
          example: OCI
      required:
        - name
      example:
        name: Website Assets
        description: File collection used for the website
        storageProvider: OCI
    UpdateProjectRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 50
          description: Project name (1-50 characters)
          example: Updated Project Name
        description:
          type: string
          maxLength: 200
          description: Project description (max 200 characters)
          example: Updated project description
      example:
        name: Updated Project Name
        description: Updated project description
    ProjectResponse:
      type: object
      properties:
        id:
          type: string
          description: Project ID
          example: clq1234abcd
        name:
          type: string
          description: Project name
          example: Website Assets
        description:
          type: string
          nullable: true
          description: Project description
          example: File collection used for the website
        storageProvider:
          type: string
          enum: *a1
          description: Storage provider
          example: OCI
        createdAt:
          type: string
          format: date-time
          description: Created at (ISO 8601)
          example: 2023-01-01T00:00:00.000Z
        updatedAt:
          type: string
          format: date-time
          description: Updated at (ISO 8601)
          example: 2023-01-01T00:00:00.000Z
      required:
        - id
        - name
        - description
        - storageProvider
        - createdAt
        - updatedAt
    ProjectListItemResponse:
      allOf:
        - $ref: "#/components/schemas/ProjectResponse"
        - type: object
          properties:
            fileCount:
              type: integer
              minimum: 0
              description: Number of files in the project
              example: 12
          required:
            - fileCount
    ProjectDetailsResponse:
      allOf:
        - $ref: "#/components/schemas/ProjectResponse"
        - type: object
          properties:
            files:
              type: array
              items:
                $ref: "#/components/schemas/FileResponse"
              description: List of files in the project
          required:
            - files
    ProjectListResponse:
      type: array
      items:
        $ref: "#/components/schemas/ProjectListItemResponse"
  parameters: {}
paths:
  /projects:
    get:
      tags:
        - Projects
      summary: List projects
      description: Retrieve all projects.
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Project list returned successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectListResponse"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
    post:
      tags:
        - Projects
      summary: Create project
      description: Create a new project.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateProjectRequest"
      responses:
        "201":
          description: Project created successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequestError"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
  /projects/{projectId}:
    get:
      tags:
        - Projects
      summary: Get project details
      description: Retrieve a specific project and its file list by project ID.
      security:
        - bearerAuth: []
      parameters:
        - schema:
            type: string
          required: true
          description: Project ID
          example: clq1234abcd
          name: projectId
          in: path
      responses:
        "200":
          description: Project returned successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectDetailsResponse"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectNotFoundError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
    delete:
      tags:
        - Projects
      summary: Delete project
      description: Delete a specific project by project ID. All files in the project are deleted as well.
      security:
        - bearerAuth: []
      parameters:
        - schema:
            type: string
          required: true
          description: Project ID
          example: clq1234abcd
          name: projectId
          in: path
      responses:
        "200":
          description: Project deleted successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
              example:
                message: Project and all related files (all versions) deleted successfully.
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "404":
          description: Project not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectNotFoundError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
  /projects/{projectId}/files/presign:
    post:
      tags:
        - Files
      summary: Generate presigned URL
      description: Generate a presigned URL for file upload. Clients can use this URL to upload files directly to OCI.
      security:
        - bearerAuth: []
      parameters:
        - schema:
            type: string
          required: true
          description: Project ID
          example: clq1234abcd
          name: projectId
          in: path
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PresignRequest"
      responses:
        "200":
          description: Presigned URL generated successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresignResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequestError"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "413":
          description: File size exceeded or storage quota exceeded
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
  /projects/{projectId}/files/confirm:
    post:
      tags:
        - Files
      summary: Confirm upload
      description: Call this after direct upload to OCI to create a file record in the database. For image files, variants can be provided to request transformation.
      security:
        - bearerAuth: []
      parameters:
        - schema:
            type: string
          required: true
          description: Project ID
          example: clq1234abcd
          name: projectId
          in: path
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ConfirmRequest"
      responses:
        "201":
          description: File record created successfully.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ConfirmResponse"
              example:
                message: Image upload and processing complete
                file:
                  id: file5678efgh
                  name: image.jpg
                  mimeType: image/jpeg
                  isImage: true
                  size: 102400
                  url: null
                  variants:
                    - url: https://objectstorage.ap-seoul-1.oraclecloud.com/...
                      width: 1920
                      height: 1080
                      size: 102400
                      format: jpeg
                      label: 1920x1080
                  createdAt: 2023-01-01T00:00:00.000Z
                  updatedAt: 2023-01-01T00:00:00.000Z
                  projectId: clq1234abcd
                variants:
                  - url: https://objectstorage.ap-seoul-1.oraclecloud.com/...
                    width: 1920
                    height: 1080
                    size: 102400
                    format: jpeg
                    label: 1920x1080
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequestError"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileNotFoundError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
  /projects/{projectId}/files/{fileId}:
    delete:
      tags:
        - Files
      summary: Delete file
      description: Delete a file with the specified ID and all related versions (including OCI storage).
      security:
        - bearerAuth: []
      parameters:
        - schema:
            type: string
          required: true
          description: Project ID
          example: clq1234abcd
          name: projectId
          in: path
        - schema:
            type: string
          required: true
          description: File ID
          example: file5678efgh
          name: fileId
          in: path
      responses:
        "200":
          description: File deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MessageResponse"
              example:
                message: File deleted successfully.
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BadRequestError"
        "401":
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UnauthorizedError"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileNotFoundError"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServerError"
